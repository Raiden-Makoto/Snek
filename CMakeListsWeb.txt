# CMakeLists.txt for Web (Emscripten) Build
cmake_minimum_required(VERSION 3.11)
project(SnakeGameWeb)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Emscripten toolchain
if(CMAKE_SYSTEM_NAME STREQUAL "Emscripten")
    set(CMAKE_EXECUTABLE_SUFFIX ".html")
endif()

# Add executable
add_executable(snake_web
    src/main.cpp
    src/game_state.cpp
    src/game_logic.cpp
    src/renderer.cpp
)

# Emscripten compiler flags
target_compile_options(snake_web PRIVATE
    $<$<PLATFORM_ID:Emscripten>:
        -s USE_GLFW=3
        -s WASM=1
        -s ALLOW_MEMORY_GROWTH=1
        -s INITIAL_MEMORY=67108864
        -s MAX_WEBGL_VERSION=2
        -s MIN_WEBGL_VERSION=2
        -s USE_WEBGL2=1
        -s FULL_ES3=1
        -s ASSERTIONS=1
        -s USE_SDL=0
        --preload-file sounds@/sounds
        -s EXPORTED_RUNTIME_METHODS='["ccall","cwrap"]'
        -s EXPORTED_FUNCTIONS='["_main"]'
        -s USE_PTHREADS=0
        -s PROXY_TO_PTHREAD=0
        -s DISABLE_DEPRECATED_FIND_EVENT_TARGET_BEHAVIOR=1
        -O2
        -DPLATFORM_WEB
    >
)

# Link flags
target_link_options(snake_web PRIVATE
    $<$<PLATFORM_ID:Emscripten>:
        -s USE_GLFW=3
        -s WASM=1
        -s ALLOW_MEMORY_GROWTH=1
        -s INITIAL_MEMORY=67108864
        -s MAX_WEBGL_VERSION=2
        -s MIN_WEBGL_VERSION=2
        -s USE_WEBGL2=1
        -s FULL_ES3=1
        --preload-file sounds@/sounds
        -s EXPORTED_RUNTIME_METHODS='["ccall","cwrap"]'
        -s EXPORTED_FUNCTIONS='["_main"]'
        -s USE_PTHREADS=0
        -s PROXY_TO_PTHREAD=0
        -s DISABLE_DEPRECATED_FIND_EVENT_TARGET_BEHAVIOR=1
        -s ERROR_ON_UNDEFINED_SYMBOLS=0
        -O2
    >
)

# Raylib for Emscripten - assuming it's installed/available
# You may need to point to your raylib build directory
find_library(RAYLIB_LIB raylib PATHS ${CMAKE_CURRENT_SOURCE_DIR}/raylib/build/emscripten)

if(RAYLIB_LIB)
    target_link_libraries(snake_web ${RAYLIB_LIB})
    message(STATUS "Found raylib at: ${RAYLIB_LIB}")
else()
    message(WARNING "raylib not found. You may need to build raylib with Emscripten first.")
    message(WARNING "Try: git clone https://github.com/raysan5/raylib.git && cd raylib/src && emmake make PLATFORM=PLATFORM_WEB")
endif()
